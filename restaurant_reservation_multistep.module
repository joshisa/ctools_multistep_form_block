<?php

/**
 * @file
 * This is a basic block module that provides an Ajax dependent dropdown form
 * Author:  joshisa@us.ibm.com
 */

/**
 * Implements hook_block_info().
 */
function restaurant_reservation_multistep_block_info() {
  $blocks = array();
  $blocks['restaurant_reservation_multistep'] = array(
    'info' => t('MultiStep Form'),
    'cache' => DRUPAL_NO_CACHE,
  );
  return $blocks;
}

/**
 * Implements hook_block_view.
 */
function restaurant_reservation_multistep_block_view($delta = '') {
  $block = array();

  switch ($delta) {
    case 'restaurant_reservation_multistep':
        $block['subject'] = '';
        $block['content'] = _restaurant_reservation_multistep_block_content();
        break;
    default:
        $block['subject'] = '';
        $block['content'] = t('Uh oh! Bullseye\'s designer has gone on vacation!');
  }
  return $block;
}

function _restaurant_reservation_multistep_block_content() {
  // $output = t('Hello World!');
  $output = drupal_render(drupal_get_form('cake_designer_form'));
  return $output;
}

function _first_dropdown_options() {
  // drupal_map_assoc() just makes an array('String' => 'String'...).
  return drupal_map_assoc(
  array(
    t('Sheet'),
    t('Round'),
    t('Pull-Apart Cupcake'),
    t('Dancer'),
    t('Brownie Sandwich'),
  )
  );
}

function _second_dropdown_options($key = '') {
  $options = array(
    t('Sheet') => drupal_map_assoc(
    array(
      t('1/4 (16-24 people)'),
      t('1/2 (32-48 people'),
      t('Full (64-96 people'),
    )
    ),
    t('Dancer') => drupal_map_assoc(
    array(
      t('1/4 (16-24 people)'),
      t('1/2 (32-48 people'),
      t('Full (64-96 people'),
    )
    ),
    t('Round') => drupal_map_assoc(
    array(
      t('Single Layer (6-10 people'),
      t('Double Layer (8-12 people'),
    )
    ),
    t('Pull-Apart Cupcake') => drupal_map_assoc(
    array(
      t('Six (6)'),
      t('Twelve (12)'),
      t('Twenty-Four (24)'),
    )
    ),
    t('Brownie Sandwich') => drupal_map_assoc(
    array(
      t('Six (6)'),
      t('Twelve (12)'),
      t('Twenty-Four (24)'),
    )
    ),
  );
  if (isset($options[$key])) {
    return $options[$key];
  }
  else {
    return array();
  }
}

function cake_designer_form($form, $form_state) {
  $options_first = _first_dropdown_options();
  $selected = isset($form_state['values']['cake_type']) ? $form_state['values']['cake_type'] : key($options_first);
  $form['model_wrapper'] = array(
    '#prefix' => '<div id="react-to-cake-type-change">',
    '#suffix' => '</div>',
  );

  $form['cake_type'] = array(
    '#type' => 'select',
    '#title' => t('Cake Type'),
    '#required' => TRUE,
    '#options' => $options_first,
    '#default_value' => $selected,
    // Bind an ajax callback to the change event.
    // Reference: https://api.drupal.org/api/examples/ajax_example!ajax_example.module/function/ajax_example_dependent_dropdown/7
    '#ajax' => array(
      'event' => 'change',
      'callback' => 'restaurant_reservation_multistep_callback',
      'wrapper' => 'model-wrapper',
      'method' => 'replace',
    )
  );

  $form['model_wrapper']['cake_size'] = array(
    '#type' => 'select',
    '#title' => $options_first[$selected] . ' ' . t('Cake Type'),
    '#prefix' => '<div id="react-to-cake-type-change">',
    '#suffix' => '</div>',
    '#options' => _second_dropdown_options($selected),
    '#default_value' => isset($form_state['values']['cake_size']) ? $form_state['values']['cake_size'] : '',
  );

  return $form;
}

function restaurant_reservation_multistep_callback($form, $form_state) {
  return $form;
}
